name: RevoPush OTA Android

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'android/version.properties'
      - 'android/**'
      - 'src/**'
      - 'package.json'
      - 'App.tsx'
  workflow_dispatch:

jobs:
  release-android:
    runs-on: ubuntu-latest

    env:
      APP_NAME: ${{ secrets.APP_NAME }}
      REVOPUSH_ACCESS_KEY: ${{ secrets.REVOPUSH_ACCESS_KEY }}
      BRANCH_NAME: ${{ github.ref_name }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Validate required secrets
        run: |
          if [ -z "${{ secrets.APP_NAME }}" ]; then
            echo "Error: APP_NAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.REVOPUSH_ACCESS_KEY }}" ]; then
            echo "Error: REVOPUSH_ACCESS_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: âš™ï¸ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ§° Setup RevoPush CLI
        uses: revopush/revopush-github-action@v1.0.0
        with:
          version: 'latest'
          accessKey: ${{ secrets.REVOPUSH_ACCESS_KEY }}

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Determine environment based on branch
        id: envselect
        run: |
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "environment=Production" >> $GITHUB_ENV
            echo "ğŸŒ Environment set to Production"
          else
            echo "environment=Staging" >> $GITHUB_ENV
            echo "ğŸŒ Environment set to Staging"
          fi
          
      - name: ğŸ“ Prepare version for RevoPush
        run: |
          VERSION_NAME=$(grep VERSION_NAME android/version.properties | cut -d'=' -f2)
          VERSION_CODE=$(grep VERSION_CODE android/version.properties | cut -d'=' -f2)
          echo "versionNameValue=$VERSION_NAME" >> android/gradle.properties
          echo "versionCodeValue=$VERSION_CODE" >> android/gradle.properties
          echo "âœ… Version configured: $VERSION_NAME ($VERSION_CODE)"
          
      - name: ğŸš€ Release Android OTA via RevoPush
        run: revopush release-react $APP_NAME android -d ${{ env.environment }}

      - name: ğŸ“¢ Send Discord Notification
        if: success()
        run: |
          ENVIRONMENT=${{ env.environment }}
          BRANCH=${{ env.BRANCH_NAME }}
          VERSION=$(grep VERSION_NAME android/version.properties | cut -d'=' -f2)
          BUILD=$(grep VERSION_CODE android/version.properties | cut -d'=' -f2)
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"âœ… RevoPush Android OTA Release Successful!\nğŸ“± App: $APP_NAME\nğŸŒ Environment: $ENVIRONMENT\nğŸŒ¿ Branch: $BRANCH\nğŸ“¦ Version: $VERSION ($BUILD)\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || echo "Discord notification failed"
